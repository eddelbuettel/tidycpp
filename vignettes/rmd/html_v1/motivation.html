<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Dirk Eddelbuettel" />
  <title>tidyCpp Motivation</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
  <style type="text/css">@charset "UTF-8";body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;line-height:1.4;max-width:800px;margin:20px auto;padding:0 10px;color:#363636;background:#fff;text-rendering:optimizeLegibility}button,input,textarea{transition:background-color .1s linear,border-color .1s linear,color .1s linear,box-shadow .1s linear,transform .1s ease}h1{font-size:2.2em;margin-top:0}h1,h2,h3,h4,h5,h6{margin-bottom:12px}h1,h2,h3,h4,h5,h6,strong{color:#000}b,h1,h2,h3,h4,h5,h6,strong,th{font-weight:600}blockquote{border-left:4px solid rgba(0,150,191,.67);margin:1.5em 0;padding:.5em 1em;font-style:italic}blockquote>footer{margin-top:10px;font-style:normal}address,blockquote cite{font-style:normal}a[href^=mailto]:before{content:"📧 "}a[href^=tel]:before{content:"📞 "}a[href^=sms]:before{content:"💬 "}button,input[type=button],input[type=checkbox],input[type=submit]{cursor:pointer}input:not([type=checkbox]):not([type=radio]),select{display:block}button,input,select,textarea{color:#000;background-color:#efefef;font-family:inherit;font-size:inherit;margin-right:6px;margin-bottom:6px;padding:10px;border:none;border-radius:6px;outline:none}button,input:not([type=checkbox]):not([type=radio]),select,textarea{-webkit-appearance:none}textarea{margin-right:0;width:100%;box-sizing:border-box;resize:vertical}button,input[type=button],input[type=submit]{padding-right:30px;padding-left:30px}button:hover,input[type=button]:hover,input[type=submit]:hover{background:#ddd}button:focus,input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px rgba(0,150,191,.67)}button:active,input[type=button]:active,input[type=checkbox]:active,input[type=radio]:active,input[type=submit]:active{transform:translateY(2px)}button:disabled,input:disabled,select:disabled,textarea:disabled{cursor:not-allowed;opacity:.5}::-webkit-input-placeholder{color:#949494}:-ms-input-placeholder{color:#949494}::-ms-input-placeholder{color:#949494}::placeholder{color:#949494}a{text-decoration:none;color:#0076d1}a:hover{text-decoration:underline}code,kbd{background:#efefef;color:#000;padding:5px;border-radius:6px}pre>code{padding:10px;display:block;overflow-x:auto}img{max-width:100%}hr{border:none;border-top:1px solid #dbdbdb}table{border-collapse:collapse;margin-bottom:10px;width:100%}td,th{padding:6px;text-align:left}th{border-bottom:1px solid #dbdbdb}tbody tr:nth-child(2n){background-color:#efefef}::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-track{background:#efefef;border-radius:6px}::-webkit-scrollbar-thumb{background:#d5d5d5;border-radius:6px}::-webkit-scrollbar-thumb:hover{background:#c4c4c4}

</style>
  <style type="text/css">
code {
padding: 2px;
border-radius: unset;
}

pre {
background-color: unset;
border: solid #aaa 1px;
padding: 8px;
}
pre.numberSource {
margin: 0;
padding-left: 0;
}
div.sourceCode {
overflow: visible;
}
pre, pre.sourceCode {
overflow-x: auto;
}
pre>code {
white-space: pre;
overflow: visible;
background-color: unset;
padding: 0;
}
pre.sourceCode.numberSource {
overflow-x: visible;
}
pre.sourceCode.numberSource>code {
white-space: pre-wrap
}
pre.sourceCode.numberSource>code>span {
left: 8px;
text-indent: -4.6em;
}

.chunk-summary {
text-align: right;
}
.chunk-summary+pre,
.chunk-summary+div.sourceCode {
margin-top: 2px;
}

nav > ul {
border: .0625rem solid #444;
border-radius: 4px;
margin: 5px;
padding: 5px;
}
nav ul {
list-style-type: none;
padding-inline-start: 1rem;
}
nav ul li {
padding: 0;
}
nav ul ul {
margin-top: 0;
margin-bottom: 0;
padding-top: 0;
padding-bottom: 0;
}
nav code {
background-color: unset;
color: unset;
}
</style>
  <style type="text/css">.tooltip {
position: relative;
display: inline-block;
}
.tooltip:before, .tooltip:after {
position: absolute;
opacity: 0;
clip: rect(0 0 0 0);
-webkit-clip-path: inset(100%);
clip-path: inset(100%);
transition: all 0.3s;
z-index: 1010;
left: 50%;
}
.tooltip:not(.bottom):before, .tooltip:not(.bottom):after {
bottom: 75%;
}
.tooltip.bottom:before, .tooltip.bottom:after {
top: 75%;
}
.tooltip:hover:before, .tooltip:hover:after, .tooltip:focus:before, .tooltip:focus:after {
opacity: 1;
clip: auto;
-webkit-clip-path: inset(0%);
clip-path: inset(0%);
}
.tooltip:before {
content: '';
background: transparent;
border: 0.5rem solid transparent;
left: calc(50% - 0.5rem);
}
.tooltip:not(.bottom):before {
border-top-color: #212121;
}
.tooltip.bottom:before {
border-bottom-color: #212121;
}
.tooltip:after {
content: attr(aria-label);
color: #fafafa;
background: #212121;
border-radius: 0.125rem;
padding: 0.5rem;
white-space: nowrap;
transform: translateX(-50%);
}
.tooltip:not(.bottom):after {
margin-bottom: 1rem;
}
.tooltip.bottom:after {
margin-top: 1rem;
}
</style>
  <style type="text/css">
.collapse {
width: calc(100% - 1rem);
opacity: 1;
display: flex;
flex-direction: column;
margin: 0.5rem;
border-radius: 0.125rem;
}
.collapse > [type="radio"], .collapse > [type="checkbox"] {
height: 1px;
width: 1px;
margin: -1px;
overflow: hidden;
position: absolute;
clip: rect(0 0 0 0);
-webkit-clip-path: inset(100%);
clip-path: inset(100%);
}
.collapse > label {
flex-grow: 1;
display: inline-block;
height: 1.5rem;
cursor: pointer;
transition: background 0.3s;
color: #212121;
background: #e8e8e8;
border: 0.0625rem solid #ddd;
padding: 0.75rem;
}
.collapse > label:hover, .collapse > label:focus {
background: #f0f0f0;
}
.collapse > label + div {
flex-basis: auto;
height: 1px;
width: 1px;
margin: -1px;
overflow: hidden;
position: absolute;
clip: rect(0 0 0 0);
-webkit-clip-path: inset(100%);
clip-path: inset(100%);
transition: max-height 0.3s;
max-height: 1px;
}
.collapse > :checked + label {
background: #ececec;
border-bottom-color: #ececec;
}
.collapse > :checked + label + div {
box-sizing: border-box;
position: relative;
width: 100%;
height: auto;
overflow: auto;
margin: 0;
border: 0.0625rem solid #ddd;
border-top: 0;
padding: 0.5rem;
clip: auto;
-webkit-clip-path: inset(0%);
clip-path: inset(0%);
max-height: 400px;
}
.collapse > label:not(:first-of-type) {
border-top: 0;
}
.collapse > label:first-of-type {
border-radius: 0.125rem 0.125rem 0 0;
}
.collapse > label:last-of-type:not(:first-of-type) {
border-radius: 0 0 0.125rem 0.125rem;
}
.collapse > label:last-of-type:first-of-type {
border-radius: 0.125rem;
}
.collapse > :checked:last-of-type:not(:first-of-type) + label {
border-radius: 0;
}
.collapse > :checked:last-of-type + label + div {
border-radius: 0 0 0.125rem 0.125rem;
}
</style>
  <script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous" data-external="1">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous" data-external="1"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);" data-external="1"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
        delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "$", right: "$$", display: false}
        ],
        displayMode: true
      });
    });
  </script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">tidyCpp Motivation</h1>
<p class="author">Dirk Eddelbuettel</p>
<p class="date">Initial (draft) version dated September 2020</p>
</header>
<article>
<section id="introducing-tidycpp" class="level2">
<h2>Introducing tidyCpp</h2>
<p>The <code>tidyCpp</code> package offers a simple, small and clean C++ layer over the C API offered by R. This vignette highlights a few usage examples, often taken from the <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html"><em>Writing R Extensions</em> vignette that comes with R</a>, to highlight some features.</p>
<p><code>tidyCpp</code> has no further dependencies on any other package. It can however be used with <a href="https://www.rcpp.org">Rcpp</a> simply to take advantage of its helper functions <code>cppFunction()</code> or <code>sourceCpp()</code>.</p>
<p><code>tidyCpp</code> is still a fairly young and small package. Please free to contribute by make suggestions, or sending bugfixes or extension proposals.</p>
<section id="snippet-one-dimnames" class="level3">
<h3>Snippet One: dimnames</h3>
<p>This example comes from <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Attributes">Writing R Extension, Section 5.9.4</a> which highlights attribute setting from the C API.</p>
<p>It takes two (named) numeric vectors, computes the outer product matrix and uses the names to set row- and column names. Note that we modified the existing example ever so slight by ensuring (as is frequently done) remapping of symbols. For example, <code>length</code> (which can clash easily with existing symbols in the global namespace) is now <code>Rf_length</code>. We also added an <code>export</code> tag for <code>Rcpp</code> simply to facilitate integration into R. No Rcpp header or data structures are used; we simply rely on its logic in getting C or C++ source into R.</p>
<div class="columns">
<div class="column" style="width:49.75%;">
<section id="using-the-c-api-for-r" class="level4">
<h4>Using the C API for R</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="pp">#define R_NO_REMAP</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>SEXP out(SEXP x, SEXP y)</span>
<span id="cb1-7"><a href="#cb1-7"></a>{</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="dt">int</span> nx = Rf_length(x), ny = Rf_length(y);</span>
<span id="cb1-9"><a href="#cb1-9"></a>  SEXP ans = PROTECT(Rf_allocMatrix(REALSXP,</span>
<span id="cb1-10"><a href="#cb1-10"></a>                                    nx, ny));</span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="dt">double</span> *rx = REAL(x),</span>
<span id="cb1-12"><a href="#cb1-12"></a>    *ry = REAL(y),</span>
<span id="cb1-13"><a href="#cb1-13"></a>    *rans = REAL(ans);</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; nx; i++) {</span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="dt">double</span> tmp = rx[i];</span>
<span id="cb1-17"><a href="#cb1-17"></a>    <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; ny; j++)</span>
<span id="cb1-18"><a href="#cb1-18"></a>      rans[i + nx*j] = tmp * ry[j];</span>
<span id="cb1-19"><a href="#cb1-19"></a>  }</span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a>  SEXP dimnames = PROTECT(Rf_allocVector(VECSXP,<span class="dv">2</span>));</span>
<span id="cb1-22"><a href="#cb1-22"></a>  SET_VECTOR_ELT(dimnames, <span class="dv">0</span>,</span>
<span id="cb1-23"><a href="#cb1-23"></a>                 Rf_getAttrib(x, R_NamesSymbol));</span>
<span id="cb1-24"><a href="#cb1-24"></a>  SET_VECTOR_ELT(dimnames, <span class="dv">1</span>,</span>
<span id="cb1-25"><a href="#cb1-25"></a>                 Rf_getAttrib(y, R_NamesSymbol));</span>
<span id="cb1-26"><a href="#cb1-26"></a>  Rf_setAttrib(ans, R_DimNamesSymbol, dimnames);</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a>  UNPROTECT(<span class="dv">2</span>);</span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="cf">return</span> ans;</span>
<span id="cb1-30"><a href="#cb1-30"></a>}</span></code></pre></div>
</section>
</div><div class="column" style="width:0.5%;">
<p> </p>
</div><div class="column" style="width:49.75%;">
<section id="using-tidycpp" class="level4">
<h4>Using tidyCpp</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">// [[Rcpp::depends(tidyCpp)]]</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>SEXP out(SEXP x, SEXP y)</span>
<span id="cb2-7"><a href="#cb2-7"></a>{</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="dt">int</span> nx = R::length(x), ny = R::length(y);</span>
<span id="cb2-9"><a href="#cb2-9"></a>  SEXP ans = R::Shield(R::allocMatrixReal(nx, ny));</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="dt">double</span> *rx = R::numericPointer(x),</span>
<span id="cb2-12"><a href="#cb2-12"></a>    *ry = R::numericPointer(y),</span>
<span id="cb2-13"><a href="#cb2-13"></a>    *rans = R::numericPointer(ans);</span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; nx; i++) {</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="dt">double</span> tmp = rx[i];</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; ny; j++)</span>
<span id="cb2-18"><a href="#cb2-18"></a>      rans[i + nx*j] = tmp * ry[j];</span>
<span id="cb2-19"><a href="#cb2-19"></a>  }</span>
<span id="cb2-20"><a href="#cb2-20"></a></span>
<span id="cb2-21"><a href="#cb2-21"></a>  SEXP dimnames = R::Shield(R::allocVectorList(<span class="dv">2</span>));</span>
<span id="cb2-22"><a href="#cb2-22"></a>  R::setVectorElement(dimnames, <span class="dv">0</span>, R::getNames(x));</span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a>  R::setVectorElement(dimnames, <span class="dv">1</span>, R::getNames(y));</span>
<span id="cb2-25"><a href="#cb2-25"></a></span>
<span id="cb2-26"><a href="#cb2-26"></a>  R::setDimNames(ans, dimnames);</span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="cf">return</span> ans;</span>
<span id="cb2-29"><a href="#cb2-29"></a>}</span></code></pre></div>
</section>
</div>
</div>
<p>Some key differences:</p>
<ul>
<li>a single header <code>tidyCpp</code>: simple and clean;</li>
<li>no <code>PROTECT</code> and <code>UNPROTECT</code> with manual calling of the number of calls made: C++ takes care of that for us via <code>Shield</code> which we borrowed (in a simplified form) from Rcpp;</li>
<li>no <code>Rf_*</code> calls: everything used comes from a clean new namespace <code>R</code> and is easily identified;</li>
<li>types are made explicit in the name of the called function sequence rather than enum;</li>
<li>consistent naming that aligns with language convention:
<ul>
<li><em>types</em> such as <code>Shield</code> are capitalized, and</li>
<li><em>verbs</em> such as the allocators or converters are camelCase;</li>
</ul></li>
<li>overall less wordy and shorter, <em>e.g.</em>, <code>R::getNames(x)</code> instead of <code>Rf_getAttrib(x, R_NamesSymbol)</code>;</li>
<li>no macros are being used.</li>
</ul>
<p>Note that the use of <code>Rcpp::export</code> does not imply use of Rcpp data structures. We simply take advantaged of the tried and true code generation to make it easy to call the example from R. You can copy either example into a temporary file and use <code>Rcpp::sourceCpp(&quot;filenameHere&quot;)</code> on it to run the example.</p>
</section>
<section id="snippet-two-convolution" class="level3">
<h3>Snippet Two: convolution</h3>
<p>This example comes from <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Calling-_002eCall">Writing R Extension, Section 5.10.1</a> which introduces the <code>.Call()</code> interface of the C API for R.</p>
<p>It takes two numeric vectors and computes a convolution. Note that as above we modified the existing example ever so slight by ensuring (as is frequently done) remapping of symbols, once again added an <code>export</code> tag for <code>Rcpp</code> simply to facilitate integration into R, and changing whitespace. No Rcpp header or data structures are used; we simply rely on its logic in getting C or C++ source into R.</p>
<div class="columns">
<div class="column" style="width:49.75%;">
<section id="using-the-c-api-for-r-1" class="level4">
<h4>Using the C API for R</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="pp">#define R_NO_REMAP</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>SEXP convolve2(SEXP a, SEXP b)</span>
<span id="cb3-7"><a href="#cb3-7"></a>{</span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="dt">int</span> na, nb, nab;</span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="dt">double</span> *xa, *xb, *xab;</span>
<span id="cb3-10"><a href="#cb3-10"></a>  SEXP ab;</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a>  a = PROTECT(Rf_coerceVector(a, REALSXP));</span>
<span id="cb3-13"><a href="#cb3-13"></a>  b = PROTECT(Rf_coerceVector(b, REALSXP));</span>
<span id="cb3-14"><a href="#cb3-14"></a>  na = Rf_length(a);</span>
<span id="cb3-15"><a href="#cb3-15"></a>  nb = Rf_length(b);</span>
<span id="cb3-16"><a href="#cb3-16"></a>  nab = na + nb - <span class="dv">1</span>;</span>
<span id="cb3-17"><a href="#cb3-17"></a>  ab = PROTECT(Rf_allocVector(REALSXP, nab));</span>
<span id="cb3-18"><a href="#cb3-18"></a>  xa = REAL(a);</span>
<span id="cb3-19"><a href="#cb3-19"></a>  xb = REAL(b);</span>
<span id="cb3-20"><a href="#cb3-20"></a>  xab = REAL(ab);</span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; nab; i++)</span>
<span id="cb3-22"><a href="#cb3-22"></a>    xab[i] = <span class="fl">0.0</span>;</span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; na; i++)</span>
<span id="cb3-24"><a href="#cb3-24"></a>    <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; nb; j++)</span>
<span id="cb3-25"><a href="#cb3-25"></a>      xab[i + j] += xa[i] * xb[j];</span>
<span id="cb3-26"><a href="#cb3-26"></a>  UNPROTECT(<span class="dv">3</span>);</span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="cf">return</span> ab;</span>
<span id="cb3-28"><a href="#cb3-28"></a>}</span></code></pre></div>
</section>
</div><div class="column" style="width:0.5%;">
<p> </p>
</div><div class="column" style="width:49.75%;">
<section id="using-tidycpp-1" class="level4">
<h4>Using tidyCpp</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">&lt;tidyCpp&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">// [[Rcpp::depends(tidyCpp)]]</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>SEXP convolve2(SEXP a, SEXP b)</span>
<span id="cb4-7"><a href="#cb4-7"></a>{</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="dt">int</span> na, nb, nab;</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="dt">double</span> *xa, *xb, *xab;</span>
<span id="cb4-10"><a href="#cb4-10"></a>  SEXP ab;</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a>  a = R::Shield(R::coerceVectorNumeric(a));</span>
<span id="cb4-13"><a href="#cb4-13"></a>  b = R::Shield(R::coerceVectorNumeric(b));</span>
<span id="cb4-14"><a href="#cb4-14"></a>  na = R::length(a);</span>
<span id="cb4-15"><a href="#cb4-15"></a>  nb = R::length(b);</span>
<span id="cb4-16"><a href="#cb4-16"></a>  nab = na + nb - <span class="dv">1</span>;</span>
<span id="cb4-17"><a href="#cb4-17"></a>  ab = R::Shield(R::allocVectorNumeric(nab));</span>
<span id="cb4-18"><a href="#cb4-18"></a>  xa = R::numericPointer(a);</span>
<span id="cb4-19"><a href="#cb4-19"></a>  xb = R::numericPointer(b);</span>
<span id="cb4-20"><a href="#cb4-20"></a>  xab = R::numericPointer(ab);</span>
<span id="cb4-21"><a href="#cb4-21"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; nab; i++)</span>
<span id="cb4-22"><a href="#cb4-22"></a>    xab[i] = <span class="fl">0.0</span>;</span>
<span id="cb4-23"><a href="#cb4-23"></a>  <span class="cf">for</span>(<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; na; i++)</span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="cf">for</span>(<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; nb; j++)</span>
<span id="cb4-25"><a href="#cb4-25"></a>      xab[i + j] += xa[i] * xb[j];</span>
<span id="cb4-26"><a href="#cb4-26"></a>  <span class="cf">return</span> ab;</span>
<span id="cb4-27"><a href="#cb4-27"></a>}</span></code></pre></div>
</section>
</div>
</div>
<p>Like the previous example, the new version operates without macros, does not require manual counting in <code>PROTECT</code> and <code>UNPROTECT</code> and is, to our eyes, a little more readable.</p>
</section>
<section id="discussion" class="level3">
<h3>Discussion</h3>
<p><code>tidyCpp</code> provides a cleaner layer on top of the C API for R. That has its advantages: we find it more readable. It conceivably has possible disadvantages. Those familiar with the C API for R may not need this, and may find it an unnecessary new dialect. Time will tell if new adoption and use may outway possible hesitation by other. In the meantime, the package “does no harm”, has no further dependencies and can be used, or dropped, at will</p>
</section>
<section id="summary" class="level3">
<h3>Summary</h3>
<p>The <code>tidyCpp</code> package provides a cleaner simplifying layer on top of the time-tested but somewhat crusty C API for R.</p>
</section>
</section>
</article>
</body>
</html>
